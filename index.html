<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Orbit - AI Workspace | Generate professional documents with AI assistance. Create, enhance, and manage Google Docs effortlessly.">
    <meta name="keywords" content="AI document generator, Google Docs, content creation, writing assistant, productivity tool">
    <meta name="author" content="Orbit AI">
    <meta property="og:title" content="Orbit - AI Workspace | Smart Document Generator">
    <meta property="og:description" content="Create professional documents with AI assistance in seconds.">
    <meta property="og:type" content="website">
    <title>Orbit Workspace</title>
    
    <link rel="icon" href="https://nicholasxdavis.github.io/docs/img/orbit.png" type="image/png">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="javascript/tailwind-config.js"></script>
    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://js.stripe.com/v3/"></script>
    
    <style>
        body {
            background-color: #161618;
            color: #fcfcfc;
        }
        
        .glassmorphism {
            background: rgba(22, 22, 24, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(36, 38, 40, 0.5);
        }
        
        .btn-micro:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -5px rgba(6, 178, 252, 0.3);
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2);
        }

        .service-icon.grayscale {
            filter: grayscale(100%);
        }
        
        .hidden { display: none; }
        
        .popup-content {
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #161618; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 6px; }
        ::-webkit-scrollbar-thumb:hover { background: #444; }

        /* Loader animation */
        .loader {
            width: 50px;
            aspect-ratio: 1;
            box-shadow: 0 0 0 3px #06b2fc inset;
            border-radius: 50%;
            position: relative;
            animation: l6 1.5s linear infinite;
        }
        .loader:before {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            box-shadow: inherit;
            width: 25px;
            aspect-ratio: 1;
            border-radius: 50%;
        }
        @keyframes l6 {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="font-sans antialiased bg-dark-primary text-dark-light min-h-screen">
    <div id="canvas-container" class="fixed inset-0 -z-10 opacity-20"></div>
    
    <div id="api-error-banner" class="hidden bg-red-600 text-white p-4 text-center fixed top-0 left-0 w-full z-[2000] glassmorphism"></div>

    <div class="container mx-auto px-4 md:px-8 py-6">
        <header class="flex justify-between items-center mb-12 animate-fade-up">
            <div class="flex items-center gap-3">
                 <img src="https://nicholasxdavis.github.io/docs/img/logo.png" alt="Orbit Logo" class="w-20 h-100%">
            </div>
            <button id="accountBtn" class="bg-dark-secondary text-dark-light font-medium py-2 px-4 rounded-lg hover:bg-dark-light/10 transition-all flex items-center gap-2 btn-micro">
                <span id="accountBtnText">Account</span>
                <span id="proBadge" class="hidden bg-[#06b2fc] text-white text-xs font-bold px-2 py-1 rounded-full">PRO</span>
            </button>
        </header>

<div id="app-content" class="max-w-4xl mx-auto animate-fade-up hidden" style="animation-delay: 0.1s">
    <div class="bg-dark-secondary/60 glassmorphism p-8 rounded-3xl shadow-xl z-[10] border-2 border-[#fcfcfc]/40">
        <div id="workspace-connector" class="mb-12 text-center">
            <h2 class="text-3xl font-bold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-cyan-300/75">Your Workspace</h2>
            <p class="mb-8 text-dark-tertiary">Link your accounts to enable the AI-powered tools.</p>
            <div id="google-services-icons" class="grid grid-cols-5 justify-items-center gap-y-6 gap-x-4">
                <a href="#" class="service-icon-link text-center no-underline" data-service="docs">
                    <div class="service-icon transition-all duration-300 cursor-pointer">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/0/01/Google_Docs_logo_%282014-2020%29.svg/47px-Google_Docs_logo_%282014-2020%29.svg.png?20220322143607" alt="Google Docs" class="h-12 w-10 grayscale opacity-70 hover:opacity-100 hover:grayscale-0" onerror="this.onerror=null; this.src='https://placehold.co/48x48/242628/fcfcfc?text=Docs';">
                    </div>
                    <p class="mt-2 text-sm text-dark-tertiary">Docs</p>
                </a>
                <a href="#" class="service-icon-link text-center no-underline" data-service="sheets">
                    <div class="service-icon transition-all duration-300 cursor-pointer">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/3/30/Google_Sheets_logo_%282014-2020%29.svg/49px-Google_Sheets_logo_%282014-2020%29.svg.png?20201024100414" alt="Google Sheets" class="h-12 w-10 grayscale opacity-70 hover:opacity-100 hover:grayscale-0" onerror="this.onerror=null; this.src='https://placehold.co/48x48/242628/fcfcfc?text=Sheets';">
                    </div>
                    <p class="mt-2 text-sm text-dark-tertiary">Sheets</p>
                </a>
                <a href="#" class="service-icon-link text-center no-underline" data-service="slides">
                    <div class="service-icon transition-all duration-300 cursor-pointer">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/1e/Google_Slides_logo_%282014-2020%29.svg/48px-Google_Slides_logo_%282014-2020%29.svg.png?20201024100433" alt="Google Slides" class="h-12 w-10 grayscale opacity-70 hover:opacity-100 hover:grayscale-0" onerror="this.onerror=null; this.src='https://placehold.co/48x48/242628/fcfcfc?text=Slides';">
                    </div>
                    <p class="mt-2 text-sm text-dark-tertiary">Slides</p>
                </a>
                <a href="#" class="service-icon-link text-center no-underline" data-service="forms">
                    <div class="service-icon transition-all duration-300 cursor-pointer">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/c2/Google_Forms_logo_%282014-2020%29.svg/48px-Google_Forms_logo_%282014-2020%29.svg.png?20201024102621" alt="Google Forms" class="h-12 w-10 grayscale opacity-70 hover:opacity-100 hover:grayscale-0" onerror="this.onerror=null; this.src='https://placehold.co/48x48/242628/fcfcfc?text=Forms';">
                    </div>
                    <p class="mt-2 text-sm text-dark-tertiary">Forms</p>
                </a>
                <a href="#" class="service-icon-link text-center no-underline" data-service="email">
                    <div class="service-icon transition-all duration-300 cursor-pointer">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/7/7e/Gmail_icon_%282020%29.svg/64px-Gmail_icon_%282020%29.svg.png" alt="Gmail" class="h-12 w-12 grayscale opacity-70 hover:opacity-100 hover:grayscale-0" onerror="this.onerror=null; this.src='https://placehold.co/48x48/242628/fcfcfc?text=Gmail';">
                    </div>
                    <p class="mt-2 text-sm text-dark-tertiary">Email</p>
                </a>
                <a href="#" class="service-icon-link text-center no-underline" data-service="mybusiness">
                    <div class="service-icon transition-all duration-300 cursor-pointer">
                        <img src="https://nicholasxdavis.github.io/docs/img/business.png" alt="Google My Business" class="h-12 w-12 grayscale opacity-70 hover:opacity-100 hover:grayscale-0" onerror="this.onerror=null; this.src='https://placehold.co/48x48/242628/fcfcfc?text=GMB';">
                    </div>
                    <p class="mt-2 text-sm text-dark-tertiary">GMB</p>
                </a>
                <a href="#" class="service-icon-link text-center no-underline" data-service="reddit">
                    <div class="service-icon transition-all duration-300 cursor-pointer">
                        <img src="https://upload.wikimedia.org/wikipedia/en/thumb/b/bd/Reddit_Logo_Icon.svg/512px-Reddit_Logo_Icon.svg.png" alt="Reddit" class="h-12 w-12 grayscale opacity-70 hover:opacity-100 hover:grayscale-0" onerror="this.onerror=null; this.src='https://placehold.co/48x48/242628/fcfcfc?text=Reddit';">
                    </div>
                    <p class="mt-2 text-sm text-dark-tertiary">Reddit</p>
                </a>
                <a href="#" class="service-icon-link text-center no-underline" data-service="discord">
                    <div class="service-icon transition-all duration-300 cursor-pointer">
                        <img src="https://nicholasxdavis.github.io/docs/img/discord.svg" alt="Discord" class="h-12 w-12 grayscale opacity-70 hover:opacity-100 hover:grayscale-0" onerror="this.onerror=null; this.src='https.placehold.co/48x48/242628/fcfcfc?text=Discord';">
                    </div>
                    <p class="mt-2 text-sm text-dark-tertiary">Discord</p>
                </a>
                <a href="#" class="service-icon-link text-center no-underline" data-service="linkedin">
                    <div class="service-icon transition-all duration-300 cursor-pointer">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/ca/LinkedIn_logo_initials.png/480px-LinkedIn_logo_initials.png" alt="LinkedIn" class="h-12 w-12 grayscale opacity-70 hover:opacity-100 hover:grayscale-0" onerror="this.onerror=null; this.src='https://placehold.co/48x48/242628/fcfcfc?text=LinkedIn';">
                    </div>
                    <p class="mt-2 text-sm text-dark-tertiary">LinkedIn</p>
                </a>
                <a href="#" class="service-icon-link text-center no-underline" data-service="social">
                    <div class="service-icon transition-all duration-300 cursor-pointer">
                        <img src="https://nicholasxdavis.github.io/docs/img/social.svg" alt="Social" class="h-12 w-12 grayscale opacity-70 hover:opacity-100 hover:grayscale-0" onerror="this.onerror=null; this.src='https://placehold.co/48x48/242628/fcfcfc?text=Social';">
                    </div>
                    <p class="mt-2 text-sm text-dark-tertiary">Social</p>
                </a>
            </div>
        </div>
    </div>

    <div class="bg-dark-secondary/60 mt-16 glassmorphism p-8 rounded-3xl shadow-xl z-[10] border-2 border-[#fcfcfc]/40">
        <div id="wc" class="mb-12">
            <h2 class="text-3xl font-bold mb-8 text-center text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-cyan-300/75">Powerful Features</h2>
            <p class="mb-8 text-dark-tertiary text-center">Link your accounts to enable the AI-powered tools.</p>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="h-full p-6 rounded-3xl bg-dark-primary flex flex-col gap-6 shadow-sm z-[10] border-2 border-[#fcfcfc]/20">
                    <div class="w-12 h-12 rounded-lg flex items-center justify-center">
                        <svg class="w-10 h-10 text-[#57add6]" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
                    </div>
                    <h3 class="text-lg font-semibold">Cross-Platform Generation</h3>
                    <p class="text-dark-tertiary text-sm">Create documents, spreadsheets, presentations, and forms instantly with AI assistance across all Google Workspace tools.</p>
                </div>
                <div class="h-full p-6 rounded-3xl bg-dark-primary flex flex-col gap-6 shadow-sm z-[10] border-2 border-[#fcfcfc]/20">
                    <div class="w-12 h-12 rounded-lg flex items-center justify-center">
                        <svg class="w-10 h-10 text-[#57add6]" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                    </div>
                    <h3 class="text-lg font-semibold">Smart Formatting</h3>
                    <p class="text-dark-tertiary text-sm">Automatically structure and format your content with AI-powered templates for each platform.</p>
                </div>
                <div class="h-full p-6 rounded-3xl bg-dark-primary flex flex-col gap-6 shadow-sm z-[10] border-2 border-[#fcfcfc]/20">
                    <div class="w-12 h-12 rounded-lg flex items-center justify-center">
                        <svg class="w-10 h-10 text-[#57add6]" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 21h7a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v11m0 5l4.879-4.879m0 0a3 3 0 104.243-4.242 3 3 0 00-4.243 4.242z"></path></svg>
                    </div>
                    <h3 class="text-lg font-semibold">Data Analysis</h3>
                    <p class="text-dark-tertiary text-sm">Transform raw data into insights with AI-powered spreadsheet formulas and visualization tools.</p>
                </div>
                <div class="h-full p-6 rounded-3xl bg-dark-primary flex flex-col gap-6 shadow-sm z-[10] border-2 border-[#fcfcfc]/20">
                    <div class="w-12 h-12 rounded-lg flex items-center justify-center">
                        <svg class="w-10 h-10 text-[#57add6]" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"></path></svg>
                    </div>
                    <h3 class="text-lg font-semibold">Presentation Design</h3>
                    <p class="text-dark-tertiary text-sm">Create stunning slides with automatic layout suggestions and design recommendations.</p>
                </div>
                <div class="h-full p-6 rounded-3xl bg-dark-primary flex flex-col gap-6 shadow-sm z-[10] border-2 border-[#fcfcfc]/20">
                    <div class="w-12 h-12 rounded-lg flex items-center justify-center">
                        <svg class="w-10 h-10 text-[#57add6]" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>
                    </div>
                    <h3 class="text-lg font-semibold">Secure Cloud Sync</h3>
                    <p class="text-dark-tertiary text-sm">All your work is automatically saved and synced across Google Workspace platforms.</p>
                </div>
                <div class="h-full p-6 rounded-3xl bg-dark-primary flex flex-col gap-6 shadow-sm z-[10] border-2 border-[#fcfcfc]/20">
                    <div class="w-12 h-12 rounded-lg flex items-center justify-center">
                        <svg class="w-10 h-10 text-[#57add6]" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                    </div>
                    <h3 class="text-lg font-semibold">Email Automation</h3>
                    <p class="text-dark-tertiary text-sm">Generate professional emails and responses with AI, directly from your Gmail.</p>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="auth-prompt" class="text-center p-10  backdrop-blur-lg rounded-3xl  max-w-md mx-auto animate-fade-up ">
    <div class="w-24 h-24 mx-auto mb-6 rounded-[2rem] bg-gradient-to-br from-cyan-400 to-blue-400/50 flex items-center justify-center shadow-lg">
        <img src="https://nicholasxdavis.github.io/docs/img/logo-white.png" alt="Orbit Logo" class="w-14 h-14">
    </div>
    <h2 class="text-4xl font-medium text-transparent bg-clip-text bg-gradient-to-r from-cyan-500 to-blue-400/95 mb-3 tracking-tight">Welcome to Orbit</h2>
    <p class="text-gray-500 mb-8 text-lg">Sign in to start creating.</p>
    <button id="masterSignInBtn" class="w-full bg-gradient-to-r from-cyan-500 to-blue-400/70 text-white p-4 rounded-xl hover:from-cyan-400 hover:to-blue-300 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 active:translate-y-0 font-medium text-lg">
        Sign In or Sign Up
    </button>
</div>

    <div id="overlay" class="fixed top-0 left-0 w-full h-full bg-black bg-opacity-70 hidden z-[1000] backdrop-blur-sm"></div>
    <div id="accountPopup" class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-sm z-[1001] hidden">
        <div class="bg-dark-secondary rounded-xl shadow-2xl p-6 relative border border-dark-tertiary/30 mx-4 popup-content">
            <button id="closeAccountPopupBtn" class="absolute top-4 right-4 text-dark-tertiary hover:text-dark-light transition text-2xl leading-none">&times;</button>
            
            <div id="loggedOutView">
                <div id="signInForm">
                    <h3 class="text-2xl font-bold mb-6 text-dark-light">Sign In</h3>
                    <input type="email" id="signInEmail" placeholder="Email" class="w-full p-3 mb-4 bg-dark-primary border border-dark-tertiary rounded-lg text-dark-light placeholder-dark-tertiary focus:outline-none focus:ring-2 focus:ring-[#06b2fc]">
                    <input type="password" id="signInPassword" placeholder="Password" class="w-full p-3 mb-4 bg-dark-primary border border-dark-tertiary rounded-lg text-dark-light placeholder-dark-tertiary focus:outline-none focus:ring-2 focus:ring-[#06b2fc]">
                    <button id="signInBtn" class="w-full bg-[#06b2fc] text-white p-3 rounded-lg hover:bg-[#0595d8] transition-all mb-4">Sign In</button>
                    <p id="signInError" class="text-red-400 mt-2 text-sm hidden"></p>
                    <p class="mt-4 text-sm text-dark-tertiary">Don't have an account? <a href="#" id="showSignUpBtn" class="text-[#06b2fc] font-medium hover:underline">Sign Up</a></p>
                </div>
                <div id="signUpForm" class="hidden">
                    <h3 class="text-2xl font-bold mb-6 text-dark-light">Create Account</h3>
                    <input type="email" id="signUpEmail" placeholder="Email" class="w-full p-3 mb-4 bg-dark-primary border border-dark-tertiary rounded-lg text-dark-light placeholder-dark-tertiary focus:outline-none focus:ring-2 focus:ring-[#06b2fc]">
                    <input type="password" id="signUpPassword" placeholder="Password (min. 6 chars)" class="w-full p-3 mb-4 bg-dark-primary border border-dark-tertiary rounded-lg text-dark-light placeholder-dark-tertiary focus:outline-none focus:ring-2 focus:ring-[#06b2fc]">
                    <button id="signUpBtn" class="w-full bg-gradient-to-r from-green-500 to-teal-500 text-white p-3 rounded-lg hover:from-green-600 hover:to-teal-600 transition-all mb-4">Sign Up</button>
                    <p id="signUpError" class="text-red-400 mt-2 text-sm hidden"></p>
                    <p class="mt-4 text-sm text-dark-tertiary">Already have an account? <a href="#" id="showSignInBtn" class="text-[#06b2fc] font-medium hover:underline">Sign In</a></p>
                </div>
            </div>

            <div id="accountActions" class="hidden">
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-12 h-12 rounded-full bg-[#06b2fc] flex items-center justify-center text-white font-bold">
                        <span id="accountInitials"></span>
                    </div>
                    <div>
                        <h3 class="font-bold text-dark-light">My Account</h3>
                        <p class="text-sm text-dark-tertiary" id="accountUserEmail"></p>
                    </div>
                </div>
                
                <div class="bg-dark-primary p-4 rounded-lg mb-6 border border-dark-tertiary/20">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-medium text-dark-tertiary">Current Plan</span>
                        <span id="accountUserPlan" class="text-sm font-bold text-[#06b2fc]"></span>
                    </div>
                    <div class="h-2 bg-dark-secondary rounded-full mb-2 overflow-hidden">
                        <div id="usageBar" class="h-full bg-[#06b2fc] rounded-full" style="width: 0%"></div>
                    </div>
                    <p id="upgrade-prompt" class="text-xs text-dark-tertiary">Upgrade to Pro for unlimited documents and AI features.</p>
                </div>
                
                <button id="upgradeToProBtn" class="w-full bg-[#06b2fc] text-white p-3 rounded-lg hover:bg-[#0595d8] transition-all mb-3">Upgrade to Pro</button>
                <button id="signOutBtn" class="w-full bg-dark-primary text-dark-light p-3 rounded-lg hover:bg-dark-tertiary/20 transition-all border border-dark-tertiary/30">Sign Out</button>
            </div>
        </div>
    </div>
    
    <div id="loading-skeleton" class="fixed inset-0 bg-dark-primary/90 z-[2000] flex items-center justify-center hidden">
        <div class="loader"></div>
    </div>
    
<script>
    // --- KEY DEOBFUSCATION ---
    const deobfuscate = (key) => key.replace(/\*/g, '');

    // --- CONFIGURATION ---
    const SUPABASE_URL = 'https://zxeikhguvghtsqouyuyz.supabase.co';
    const SUPABASE_ANON_KEY_OBFUSCATED = 'e*y*J*h*b*G*c*i*O*i*J*I*U*z*I*1*N*i*I*s*I*n*R*5*c*C*I*6*I*k*p*X*V*C*J*9*.*e*y*J*p*c*3*M*i*O*i*J*z*d*X*B*h*Y*m*F*z*Z*S*I*s*I*n*J*l*Z*i*I*6*I*n*p*4*Z*W*l*r*a*G*d*1*d*m*d*o*d*H*N*x*b*3*V*5*d*X*l*6*I*i*w*i*c*m*9*s*Z*S*I*6*I*m*F*u*b*2*4*i*L*C*J*p*Y*X*Q*i*O*j*E*3*N*T*E*1*O*D*Y*y*M*z*A*s*I*m*V*4*c*C*I*6*M*j*A*2*N*z*E*2*M*j*I*z*M*H*0*.*a*9*j*W*r*_*h*1*d*g*y*i*_*S*T*7*s*g*K*D*A*S*D*H*i*7*h*k*M*j*S*W*O*R*7*8*V*q*2*f*M*N*0';
    const supabase = window.supabase.createClient(SUPABASE_URL, deobfuscate(SUPABASE_ANON_KEY_OBFUSCATED));
    
    const STRIPE_PUBLISHABLE_KEY_OBFUSCATED = 'p*k*_*t*e*s*t*_*5*1*R*8*v*i*v*G*r*s*d*J*U*1*d*j*q*O*m*J*c*5*5*2*p*6*s*q*z*K*V*m*1*Q*p*r*L*I*R*a*l*h*n*a*J*m*i*e*7*3*H*c*6*A*o*j*0*j*V*G*G*J*m*I*x*B*K*1*z*6*H*p*H*I*B*Q*Y*m*e*V*A*B*B*E*p*Q*S*8*8*0*0*w*g*y*G*p*O*4*y';
    const stripe = Stripe(deobfuscate(STRIPE_PUBLISHABLE_KEY_OBFUSCATED));

    // --- REDDIT CONFIG ---
    const REDDIT_CLIENT_ID = 'k8zVPy-VzLzKS1XOETZhug';
    const REDDIT_CLIENT_SECRET_OBFUSCATED = 'J*q*I*-*5*k*4*M*W*7*b*K*j*Z*Y*n*P*a*i*e*w*d*P*Y*Y*O*f*j*3*A';

    // --- GOOGLE API CONFIG ---
    const GOOGLE_API_KEY_OBFUSCATED = 'A*I*z*a*S*y*A*U*I*v*4*H*E*M*u*f*F*0*x*5*1*e*Z*q*L*p*e*o*R*t*J*X*8*W*n*r*n*i*o';
    const GOOGLE_CLIENT_ID_OBFUSCATED = '4*6*7*1*2*2*3*4*7*1*9*5*-*5*g*g*9*e*i*8*a*h*f*l*e*0*t*t*s*e*6*j*s*l*t*2*k*k*h*i*m*l*k*k*1*.*a*p*p*s*.*g*o*o*g*l*e*u*s*e*r*c*o*n*t*e*n*t*.*c*o*m';
    const DISCOVERY_DOCS = [
        'https://docs.googleapis.com/$discovery/rest?version=v1',
        'https://sheets.googleapis.com/$discovery/rest?version=v4',
        'https://slides.googleapis.com/$discovery/rest?version=v1',
        'https://forms.googleapis.com/$discovery/rest?version=v1',
        'https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest'
    ];
    const SCOPES = [
        'https://www.googleapis.com/auth/documents', 
        'https://www.googleapis.com/auth/drive.file',
        'https://www.googleapis.com/auth/spreadsheets',
        'https://www.googleapis.com/auth/presentations',
        'https://www.googleapis.com/auth/forms.body',
        'https://www.googleapis.com/auth/gmail.send',
        'https://www.googleapis.com/auth/gmail.readonly'
    ].join(' ');

    // --- GLOBAL VARIABLES ---
    let tokenClient;
    let threeJSInitialized = false;
    let pendingService = null; 
    let authManager; 

    // --- AUTH MANAGER CLASS ---
    class AuthManager {
        constructor() {
            this.user = null;
            this.session = null;
            this.hasActiveSubscription = false;
            this.userPlan = 'free';
            this.paymentLoading = false;
            this.documentCount = 0;
            this.maxDocuments = 5;
            this.socialTokens = [];
        }

        async initializeAuth() {
            this.setupAuthEventListeners();
            this.showLoading(true);
            const { data: { session } } = await supabase.auth.getSession();
            this.session = session;
            this.user = session?.user || null;
            
            if (this.user) {
                await this.loadUsage();
                await this.loadSocialTokens();
            }
            
            this.updateUI();
            this.showLoading(false);

            supabase.auth.onAuthStateChange(async (event, session) => {
                this.session = session;
                this.user = session?.user || null;
                if (event === 'SIGNED_OUT') {
                    this.handleGoogleSignOut(false);
                }
                if (this.user) {
                    await this.loadUsage();
                    await this.loadSocialTokens();
                    loadGoogleToken();
                }
                this.updateUI();
            });
        }

        showLoading(show) {
            document.getElementById('loading-skeleton').classList.toggle('hidden', !show);
        }

        setupAuthEventListeners() {
            document.getElementById('accountBtn').addEventListener('click', () => this.toggleAccountPopup());
            document.getElementById('masterSignInBtn').addEventListener('click', () => this.toggleAccountPopup(true));
            document.getElementById('signOutBtn').addEventListener('click', () => this.handleSignOut());
            document.getElementById('closeAccountPopupBtn').addEventListener('click', () => this.closeAccountPopup());
            document.getElementById('overlay').addEventListener('click', () => this.closeAccountPopup());
            document.getElementById('upgradeToProBtn').addEventListener('click', () => this.handleUpgrade());
            document.getElementById('signInBtn').addEventListener('click', () => this.handleSignIn());
            document.getElementById('signUpBtn').addEventListener('click', () => this.handleSignUp());
            document.getElementById('showSignUpBtn').addEventListener('click', (e) => { e.preventDefault(); this.showSignUpForm(); });
            document.getElementById('showSignInBtn').addEventListener('click', (e) => { e.preventDefault(); this.showSignInForm(); });
        }
        
        async loadSocialTokens() {
            if (!this.user) return;
            
            try {
                const { data, error } = await supabase
                    .from('user_social_tokens')
                    .select('service, access_token, refresh_token, expires_at')
                    .eq('user_id', this.user.id);
                
                if (error) throw error;
                
                this.socialTokens = data || [];
                this.updateServiceIcons();
            } catch (error) {
                console.error('Error loading social tokens:', error);
                this.socialTokens = [];
            }
        }

        updateServiceIcons() {
            const icons = document.querySelectorAll('.service-icon img');
            icons.forEach(icon => {
                const service = icon.closest('.service-icon-link').dataset.service;
                const isAuthed = this.isServiceAuthed(service);
                icon.classList.toggle('grayscale', !isAuthed);
                icon.classList.toggle('opacity-70', !isAuthed);
                icon.classList.toggle('opacity-100', isAuthed);
                icon.classList.toggle('grayscale-0', isAuthed);
            });
        }

        isServiceAuthed(service) {
            if (['docs', 'sheets', 'slides', 'forms', 'email', 'mybusiness'].includes(service)) {
                return !!gapi.client.getToken()?.access_token;
            }
            
            const token = this.socialTokens.find(t => t.service === service);
            if (!token) return false;
            
            return new Date(token.expires_at) > new Date();
        }
        
        async saveSocialToken(service, tokenResponse) {
            if (!this.user) return;
            
            const expiresAt = new Date();
            expiresAt.setSeconds(expiresAt.getSeconds() + (tokenResponse.expires_in || 31536000)); // Default to 1 year if expires_in not provided
            
            const { error } = await supabase
                .from('user_social_tokens')
                .upsert({
                    user_id: this.user.id,
                    service,
                    access_token: tokenResponse.access_token,
                    refresh_token: tokenResponse.refresh_token,
                    expires_at: expiresAt.toISOString()
                }, { onConflict: 'user_id,service' });

            if (error) {
                console.error(`Error saving ${service} token:`, error);
            } else {
                await this.loadSocialTokens();
            }
        }

        async handleServiceAuth(service) {
            switch(service) {
                case 'reddit':
                    // Store the current path to redirect back after auth
                    localStorage.setItem('reddit_auth_redirect', window.location.pathname);
                    window.location.href = `https://www.reddit.com/api/v1/authorize?client_id=${REDDIT_CLIENT_ID}&response_type=code&state=orbit_reddit&redirect_uri=${window.location.origin}&duration=permanent&scope=identity,edit,flair,history,modconfig,modflair,modlog,modposts,modwiki,mysubreddits,privatemessages,read,report,save,submit,subscribe,vote,wikiedit,wikiread`;
                    break;
                // Add cases for other services later
                default:
                    console.warn('Service auth not implemented:', service);
            }
        }
        
        async handleSignIn() {
            const email = document.getElementById('signInEmail').value;
            const password = document.getElementById('signInPassword').value;
            const signInError = document.getElementById('signInError');
            if (!email || !password) {
                signInError.textContent = 'Please fill in all fields';
                signInError.classList.remove('hidden');
                return;
            }
            this.showLoading(true);
            const { error } = await supabase.auth.signInWithPassword({ email, password });
            if (error) {
                signInError.textContent = error.message;
                signInError.classList.remove('hidden');
                this.showLoading(false);
            } else {
                this.closeAccountPopup();
                this.showLoading(false);
            }
        }
        
        async handleSignUp() {
            const email = document.getElementById('signUpEmail').value;
            const password = document.getElementById('signUpPassword').value;
            const signUpError = document.getElementById('signUpError');
            if (!email || password.length < 6) {
                signUpError.textContent = 'Password must be at least 6 characters.';
                signUpError.classList.remove('hidden');
                return;
            }
            this.showLoading(true);
            const { error } = await supabase.auth.signUp({ email, password });
            if (error) {
                signUpError.textContent = error.message;
                signUpError.classList.remove('hidden');
            } else {
                alert('Check your email for a confirmation link!');
                this.closeAccountPopup();
            }
            this.showLoading(false);
        }

        async handleSignOut() {
            this.showLoading(true);
            await supabase.auth.signOut();
            this.closeAccountPopup();
            this.showLoading(false);
        }

        handleGoogleSignOut(showLoader = true) {
            if(showLoader) this.showLoading(true);
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token, () => {
                    gapi.client.setToken(null);
                    this.updateServiceIcons();
                });
            } else {
                this.updateServiceIcons();
            }
            if(showLoader) this.showLoading(false);
        }

        async handleUpgrade() {
            if (this.paymentLoading) return;
            this.paymentLoading = true;
            
            try {
                const { data, error } = await supabase.functions.invoke('create-checkout-session', {
                    body: JSON.stringify({
                        user_id: this.user.id,
                        email: this.user.email
                    })
                });
                
                if (error) {
                    console.error('Supabase function error:', error);
                    alert('Failed to start payment process. Please try again later.');
                    return;
                }
                
                if (!data?.sessionId) {
                    throw new Error('Invalid response from server');
                }
                
                const result = await stripe.redirectToCheckout({
                    sessionId: data.sessionId
                });
                
                if (result.error) {
                    throw result.error;
                }
            } catch (error) {
                console.error('Payment error:', error);
                alert(`Payment failed: ${error.message}`);
            } finally {
                this.paymentLoading = false;
            }
        }

        async loadUsage() {
            try {
                const { data, error } = await supabase
                    .from('user_usage')
                    .select('document_count, is_pro')
                    .eq('user_id', this.user.id)
                    .single();
                
                if (error) throw error;
                
                this.documentCount = data?.document_count || 0;
                this.hasActiveSubscription = data?.is_pro || false;
                this.userPlan = this.hasActiveSubscription ? 'pro' : 'free';
                
                const usagePercentage = this.hasActiveSubscription ? 100 : 
                    Math.min(100, (this.documentCount / 20) * 100);
                document.getElementById('usageBar').style.width = `${usagePercentage}%`;
            } catch (error) {
                console.error('Error loading usage:', error);
                const { error: insertError } = await supabase
                    .from('user_usage')
                    .insert([{ 
                        user_id: this.user.id,
                        document_count: 0,
                        is_pro: false 
                    }]);
                
                if (insertError) console.error('Error initializing usage:', insertError);
                else {
                    this.documentCount = 0;
                    this.hasActiveSubscription = false;
                    document.getElementById('usageBar').style.width = '0%';
                }
            }
        }

        updateUI() {
            const isLoggedIn = !!this.user;
            document.getElementById('app-content').classList.toggle('hidden', !isLoggedIn);
            document.getElementById('auth-prompt').classList.toggle('hidden', isLoggedIn);
            this.updateAccountPopupUI();
            if (isLoggedIn && !threeJSInitialized) {
                initThreeJSBackground();
                initAnimations();
                threeJSInitialized = true;
            }
        }

        updateAccountPopupUI() {
            const loggedOutView = document.getElementById('loggedOutView');
            const accountActions = document.getElementById('accountActions');
            const proBadge = document.getElementById('proBadge');

            if (this.user) {
                document.getElementById('accountUserEmail').textContent = this.user.email;
                document.getElementById('accountUserPlan').textContent = this.userPlan === 'pro' ? 'Pro' : 'Free';
                proBadge.classList.toggle('hidden', !this.hasActiveSubscription);
                document.getElementById('upgradeToProBtn').classList.toggle('hidden', this.hasActiveSubscription);
                document.getElementById('upgrade-prompt').classList.toggle('hidden', this.hasActiveSubscription);
                
                const initials = this.user.email.slice(0, 2).toUpperCase();
                document.getElementById('accountInitials').textContent = initials;
                
                loggedOutView.classList.add('hidden');
                accountActions.classList.remove('hidden');
            } else {
                loggedOutView.classList.remove('hidden');
                accountActions.classList.add('hidden');
                this.showSignInForm();
                proBadge.classList.add('hidden');
            }
        }

        toggleAccountPopup(forceOpen = false) {
            const popup = document.getElementById('accountPopup');
            const overlay = document.getElementById('overlay');
            if (forceOpen || popup.classList.contains('hidden')) {
                popup.classList.remove('hidden');
                overlay.classList.remove('hidden');
                this.updateAccountPopupUI();
            } else {
                this.closeAccountPopup();
            }
        }
        closeAccountPopup() {
            document.getElementById('accountPopup').classList.add('hidden');
            document.getElementById('overlay').classList.add('hidden');
        }
        showSignUpForm() {
            document.getElementById('signInForm').classList.add('hidden');
            document.getElementById('signUpForm').classList.remove('hidden');
            document.getElementById('signInError').classList.add('hidden');
        }
        showSignInForm() {
            document.getElementById('signUpForm').classList.add('hidden');
            document.getElementById('signInForm').classList.remove('hidden');
            document.getElementById('signUpError').classList.add('hidden');
        }
    }

    // --- VISUALS & ANIMATIONS ---
    function initThreeJSBackground() {
        const container = document.getElementById('canvas-container');
        if (!container) return;
        const width = container.clientWidth;
        const height = container.clientHeight;
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, width / height, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
        renderer.setSize(width, height);
        renderer.setPixelRatio(window.devicePixelRatio);
        container.appendChild(renderer.domElement);
        
        const particlesGeometry = new THREE.BufferGeometry();
        const particleCount = 100;
        const posArray = new Float32Array(particleCount * 3);
        for (let i = 0; i < particleCount * 3; i++) {
            posArray[i] = (Math.random() - 0.5) * 10;
        }
        particlesGeometry.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
        const particlesMaterial = new THREE.PointsMaterial({
            size: 0.05,
            color: 0x50b1f7,
            transparent: true,
            opacity: 0.8,
            blending: THREE.AdditiveBlending
        });
        const particlesMesh = new THREE.Points(particlesGeometry, particlesMaterial);
        scene.add(particlesMesh);
        camera.position.z = 3;

        function animate() {
            requestAnimationFrame(animate);
            particlesMesh.rotation.x += 0.0005;
            particlesMesh.rotation.y += 0.0005;
            renderer.render(scene, camera);
        }
        animate();

        window.addEventListener('resize', () => {
            const newWidth = container.clientWidth;
            const newHeight = container.clientHeight;
            camera.aspect = newWidth / newHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(newWidth, newHeight);
        });
    }

    function initAnimations() {
        gsap.utils.toArray('.animate-fade-up').forEach(el => {
            gsap.from(el, { y: 20, opacity: 0, duration: 0.8, ease: "power2.out", scrollTrigger: { trigger: el, start: "top 80%", toggleActions: "play none none none" } });
        });
        gsap.utils.toArray('.card-hover').forEach((card, i) => {
            gsap.from(card, { x: i % 2 === 0 ? -20 : 20, opacity: 0, duration: 0.6, delay: i * 0.1, ease: "back.out(1.7)", scrollTrigger: { trigger: card, start: "top 85%", toggleActions: "play none none none" } });
        });
    }

    // --- GLOBAL FUNCTIONS ---
    function handleServiceClick(service) {
        if (!authManager.user) {
            authManager.toggleAccountPopup(true);
            return;
        }

        // Handle Google services
        if (['docs', 'sheets', 'slides', 'forms', 'email', 'mybusiness'].includes(service)) {
            const isGoogleAuthed = !!gapi.client.getToken()?.access_token;
            if (!isGoogleAuthed) {
                pendingService = service;
                tokenClient.requestAccessToken({ prompt: 'consent' });
                return;
            }
            window.location.href = `./dashboard/${service}/`;
            return;
        }

        // Handle social services
        switch(service) {
            case 'reddit':
                const redditToken = authManager.socialTokens.find(t => t.service === 'reddit');
                if (!redditToken || new Date(redditToken.expires_at) <= new Date()) {
                    authManager.handleServiceAuth('reddit');
                } else {
                    window.location.href = './dashboard/reddit/';
                }
                break;
            // Add cases for other services
            default:
                console.warn('Service not implemented:', service);
        }
    }

    async function saveGoogleToken(tokenResponse) {
        if (!authManager.user) return;

        // Set expires_at to 1 year from now
        const oneYearMs = 365 * 24 * 60 * 60 * 1000;
        const expires_at = new Date(Date.now() + oneYearMs).toISOString();

        const { error } = await supabase
            .from('user_social_tokens')
            .upsert({
                user_id: authManager.user.id,
                service: 'google',
                access_token: tokenResponse.access_token,
                expires_at: expires_at,
                updated_at: new Date().toISOString()
            }, { onConflict: 'user_id,service' });

        if (error) console.error('Error saving Google token:', error);
    }

    async function loadGoogleToken() {
        if (!authManager.user) {
            authManager.updateServiceIcons();
            return;
        }

        try {
            const { data, error } = await supabase
                .from('user_social_tokens')
                .select('access_token, expires_at')
                .eq('user_id', authManager.user.id)
                .eq('service', 'google');

            if (error) {
                console.error('Supabase error:', error);
                return;
            }

            if (data && data.length > 0 && new Date(data[0].expires_at) > new Date()) {
                gapi.client.setToken({ access_token: data[0].access_token });
                authManager.updateServiceIcons();
            } else {
                authManager.updateServiceIcons();
                if (data && data.length > 0) {
                    await supabase.from('user_social_tokens')
                        .delete()
                        .eq('user_id', authManager.user.id)
                        .eq('service', 'google');
                }
            }
        } catch (err) {
            console.error('Failed to load Google token:', err);
        }
    }

    async function completeRedditAuth(code) {
        authManager.showLoading(true);
        try {
            // First get the session to ensure we're logged in
            const { data: { session }, error: sessionError } = await supabase.auth.getSession();
            if (sessionError || !session) throw new Error('No active session');
            
            // Exchange the code for tokens
            const response = await fetch('https://www.reddit.com/api/v1/access_token', {
                method: 'POST',
                headers: {
                    'Authorization': `Basic ${btoa(`${REDDIT_CLIENT_ID}:${deobfuscate(REDDIT_CLIENT_SECRET_OBFUSCATED)})}`,
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `grant_type=authorization_code&code=${code}&redirect_uri=${window.location.origin}`
            });
            
            if (!response.ok) throw new Error('Failed to get access token');
            const tokenData = await response.json();
            
            // Save the token
            await authManager.saveSocialToken('reddit', tokenData);
            
            // Redirect back to the original path
            const redirectPath = localStorage.getItem('reddit_auth_redirect') || './';
            localStorage.removeItem('reddit_auth_redirect');
            window.location.href = redirectPath;
            
        } catch (error) {
            console.error('Reddit auth error:', error);
            alert('Failed to connect Reddit account. Please try again.');
        } finally {
            authManager.showLoading(false);
        }
    }

    // --- MAIN APP LOGIC ---
    document.addEventListener('DOMContentLoaded', () => {
        authManager = new AuthManager();
        
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            try {
                await gapi.client.init({
                    apiKey: deobfuscate(GOOGLE_API_KEY_OBFUSCATED),
                    discoveryDocs: DISCOVERY_DOCS,
                });
                const gisScript = document.createElement('script');
                gisScript.src = 'https://accounts.google.com/gsi/client';
                gisScript.async = true;
                gisScript.defer = true;
                gisScript.onload = gisLoaded;
                document.body.appendChild(gisScript);
            } catch (error) {
                console.error("Error initializing GAPI client:", error);
            }
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: deobfuscate(GOOGLE_CLIENT_ID_OBFUSCATED),
                scope: SCOPES,
                callback: async (tokenResponse) => {
                    if (tokenResponse && tokenResponse.access_token) {
                        await saveGoogleToken(tokenResponse);
                        gapi.client.setToken(tokenResponse);
                        authManager.updateServiceIcons();

                        if (pendingService) {
                            handleServiceClick(pendingService);
                            pendingService = null;
                        }
                    } else {
                        console.error("Invalid token response:", tokenResponse);
                    }
                },
            });
            
            // Check if we're returning from Reddit auth
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');

            if (code && state === 'orbit_reddit') {
                completeRedditAuth(code);
            } else {
                authManager.initializeAuth().then(() => {
                    if (authManager.user) {
                        loadGoogleToken();
                    }
                });
            }
        }

        window.onload = gapiLoaded;
        
        document.querySelectorAll('.service-icon-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                handleServiceClick(link.dataset.service);
            });
        });
    });
</script>
</body>
</html>
